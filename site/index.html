<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MedorCoin — Blockchain Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="MedorCoin Blockchain Portal — Learn, verify crypto payments, access courses, and earn certificates."/>
  <style>
    :root {
      --bg: #0e0f12;
      --panel: #12141a;
      --border: #252833;
      --text: #eaecef;
      --muted: #98a2b3;
      --primary: #2b5cff;
      --primary-2: #7aa2ff;
      --green: #4ade80;
      --orange: #f59e0b;
      --red: #ef4444;
    }
    * { box-sizing: border-box; }
    body { font-family: system-ui, Arial, sans-serif; margin: 0; background: var(--bg); color: var(--text); }
    header, footer { background: var(--panel); border-bottom: 1px solid var(--border); }
    header .container, main .container, footer .container { max-width: 1100px; margin: 0 auto; padding: 16px; }
    h1, h2, h3 { margin: 12px 0; }
    p { line-height: 1.5; }
    .row { display: flex; flex-wrap: wrap; gap: 12px; align-items: center; }
    .spaced { justify-content: space-between; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 14px; }
    .card { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 16px; }
    .hero { padding: 32px 0; }
    .btn { display: inline-block; padding: 10px 14px; background: var(--primary); color: #fff; border: none; border-radius: 8px; cursor: pointer; text-decoration: none; }
    .btn.secondary { background: #2a2f3a; color: var(--text); }
    .btn.ghost { background: transparent; border: 1px solid var(--border); }
    .muted { color: var(--muted); }
    .badge { padding: 4px 10px; background: #1b1f2a; border: 1px solid var(--border); border-radius: 999px; font-size: 12px; }
    .status-dot { display:inline-block; width:10px; height:10px; border-radius:50%; margin-right:6px; background:#5a657a; }
    .ok { background: #22c55e; }
    .warn { background: #f59e0b; }
    .err { background: #ef4444; }
    a { color: var(--primary-2); text-decoration: none; }
    a:hover { text-decoration: underline; }
    code { background:#0f1320; padding:2px 4px; border-radius:4px; }
    .iconbox { padding: 14px; border-radius: 10px; border: 1px solid var(--border); background: #101319; }
    .iconbox h3 { margin: 6px 0 8px; }
  </style>
</head>
<body>
<header>
  <div class="container row spaced">
    <div class="row" style="gap:8px;">
      <img alt="MedorCoin logo" src="https://invi-dor.github.io/MedorCoin-Blockchain/assets/logo.png" onerror="this.style.display='none';" style="height:28px;border-radius:6px;">
      <h1 style="margin:0;">MedorCoin — Blockchain Portal</h1>
    </div>
    <div class="row">
      <span id="userEmail" class="badge">Not logged in</span>
      <button class="btn" onclick="loginRequest()">Log in</button>
      <button class="btn secondary" onclick="logout()">Log out</button>
    </div>
  </div>
</header>

<main>
  <section class="hero">
    <div class="container">
      <h2>Learn. Verify. Earn Certificates.</h2>
      <p class="muted">Crypto-native learning with real on-chain payment verification across ETH/BNB (EVM) and BTC. Unlock levels and certify your progress.</p>
      <div class="row" style="margin-top:12px;">
        <a class="btn" href="https://invi-dor.github.io/MedorCoin-Blockchain/site/learners.html">Enter Learners Portal</a>
        <a class="btn secondary" href="https://invi-dor.github.io/MedorCoin-Blockchain/site/my-classroom.html">Go to My Classroom</a>
      </div>
    </div>
  </section>

  <section class="container card">
    <h2>Quick Start</h2>
    <div class="grid">
      <div class="iconbox">
        <h3>1) Log in</h3>
        <p class="muted">Use magic-link email. No passwords.</p>
        <button class="btn ghost" onclick="loginRequest()">Send login link</button>
      </div>
      <div class="iconbox">
        <h3>2) Pay on-chain</h3>
        <p class="muted">Send to our addresses and paste your tx hash to unlock access.</p>
        <small class="muted">EVM: <code>0x85708d61FEfcbb6eb13C72b0D42bCeB246F06dd0</code><br/>BTC: <code>bc1qlw9h0nnde9yewacdkfetcym96l24ucu5ld9atv</code></small>
      </div>
      <div class="iconbox">
        <h3>3) Learn & Certify</h3>
        <p class="muted">Complete lessons, pass quizzes, and download your certificate.</p>
        <a class="btn ghost" href="https://invi-dor.github.io/MedorCoin-Blockchain/site/my-classroom.html">Open Classroom</a>
      </div>
    </div>
  </section>

  <section class="container card" style="margin-top:16px;">
    <h2>Live Status</h2>
    <div class="grid">
      <div>
        <h3><span id="apiDot" class="status-dot"></span>API</h3>
        <p id="apiStatus" class="muted">Checking...</p>
      </div>
      <div>
        <h3><span id="authDot" class="status-dot"></span>Auth</h3>
        <p id="authStatus" class="muted">Checking...</p>
      </div>
      <div>
        <h3><span id="payDot" class="status-dot"></span>Payments</h3>
        <p id="payStatus" class="muted">Checking...</p>
      </div>
    </div>
  </section>

  <section class="container card" style="margin-top:16px;">
    <h2>Learners & Classroom</h2>
    <div class="grid">
      <div class="iconbox">
        <h3>Learners Portal</h3>
        <p class="muted">Verify payment, view access, and issue certificates.</p>
        <a class="btn" href="https://invi-dor.github.io/MedorCoin-Blockchain/site/learners.html">Open Learners</a>
      </div>
      <div class="iconbox">
        <h3>My Classroom</h3>
        <p class="muted">Complete lessons and take quizzes to unlock levels.</p>
        <a class="btn secondary" href="https://invi-dor.github.io/MedorCoin-Blockchain/site/my-classroom.html">Open Classroom</a>
      </div>
    </div>
  </section>
</main>

<footer>
  <div class="container row spaced">
    <small class="muted">MedorCoin ©</small>
    <small class="muted">Site: https://invi-dor.github.io/MedorCoin-Blockchain</small>
  </div>
</footer>

<script>
  // Frontend site root (GitHub Pages)
  const SITE_ROOT = 'https://invi-dor.github.io/MedorCoin-Blockchain';

  // Backend API base URL — replace with your live API (must allow CORS for https://invi-dor.github.io)
  window.__ENV = window.__ENV || {};
  window.__ENV.API_BASE = window.__ENV.API_BASE || 'https://YOUR-LIVE-API-BASE';

  let AUTH_TOKEN = localStorage.getItem('mc_token') || null;

  function setDot(id, status){
    const dot = document.getElementById(id);
    dot.classList.remove('ok','warn','err');
    if(status === 'ok') dot.classList.add('ok');
    else if(status === 'warn') dot.classList.add('warn');
    else if(status === 'err') dot.classList.add('err');
  }

  function authHeaders(){ return AUTH_TOKEN ? { Authorization: 'Bearer ' + AUTH_TOKEN } : {}; }

  function logout(){
    localStorage.removeItem('mc_token');
    AUTH_TOKEN = null;
    document.getElementById('userEmail').textContent = 'Not logged in';
    alert('Logged out');
  }

  async function loginRequest(){
    const email = prompt('Enter your email to receive a login link:');
    if(!email) return;
    const redirectUrl = SITE_ROOT + '/site/learners.html/auth-complete';
    try{
      const r = await fetch(`${window.__ENV.API_BASE}/api/auth/request`, {
        method:'POST', headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ email, redirectUrl })
      });
      if(r.ok){
        alert('Check your email for the login link. If email is not configured, see backend logs for the link.');
      } else {
        alert('Login request failed. Check API and CORS.');
      }
    }catch{
      alert('Network/CORS error requesting login link.');
    }
  }

  // Magic-link completion support (if homepage is used as callback)
  (function checkAuthComplete(){
    if (location.pathname.endsWith('/auth-complete')) {
      const token = location.hash.replace('#token=', '');
      if (token) {
        localStorage.setItem('mc_token', token);
        AUTH_TOKEN = token;
        alert('Logged in.');
        window.location.href = SITE_ROOT + '/';
      }
    }
  })();

  async function me(auto=false){
    if(!AUTH_TOKEN){ return; }
    try{
      const r = await fetch(`${window.__ENV.API_BASE}/api/me`, { headers: { ...authHeaders() } });
      if (r.ok){
        const j = await r.json();
        if(j?.user?.email){
          const el = document.getElementById('userEmail');
          if (el.textContent !== j.user.email) el.textContent = j.user.email;
        }
        setDot('authDot','ok');
        document.getElementById('authStatus').textContent = 'Authenticated';
      } else if (r.status === 401) {
        logout();
        setDot('authDot','warn');
        document.getElementById('authStatus').textContent = 'Not authenticated';
      } else {
        setDot('authDot','warn');
        document.getElementById('authStatus').textContent = 'Auth check failed';
      }
    }catch{
      if(!auto){
        setDot('authDot','err');
        document.getElementById('authStatus').textContent = 'Auth unreachable';
      }
    }
  }

  async function checkApi(auto=false){
    try{
      const r = await fetch(`${window.__ENV.API_BASE}/health`, { method:'GET' });
      if(r.ok){
        setDot('apiDot','ok');
        document.getElementById('apiStatus').textContent = 'Healthy';
      }else{
        setDot('apiDot','warn');
        document.getElementById('apiStatus').textContent = 'API responding with errors';
      }
    }catch{
      if(!auto){
        setDot('apiDot','err');
        document.getElementById('apiStatus').textContent = 'API unreachable';
      }
    }
  }

  async function checkPayments(auto=false){
    try{
      const r = await fetch(`${window.__ENV.API_BASE}/api/payments/status`);
      if(r.ok){
        const j = await r.json();
        const ok = j?.evm?.ok || j?.btc?.ok;
        setDot('payDot', ok ? 'ok' : 'warn');
        document.getElementById('payStatus').textContent = ok ? 'Verifiers online' : 'Partial/outage';
      }else{
        setDot('payDot','warn');
        document.getElementById('payStatus').textContent = 'Status endpoint error';
      }
    }catch{
      if(!auto){
        setDot('payDot','err');
        document.getElementById('payStatus').textContent = 'Payment status unreachable';
      }
    }
  }

  function startAutoUpdates(){
    checkApi(true); checkPayments(true); me(true);
    window.__idxIntervals = window.__idxIntervals || [];
    window.__idxIntervals.forEach(id=>clearInterval(id));
    window.__idxIntervals = [
      setInterval(()=>checkApi(true), 20000),
      setInterval(()=>checkPayments(true), 20000),
      setInterval(()=>me(true), 20000),
    ];
  }

  // Initialize
  (function init(){
    // Initial status checks
    checkApi();
    checkPayments();
    me();
    if (AUTH_TOKEN) startAutoUpdates();
    document.addEventListener('visibilitychange', ()=>{ if(!document.hidden){ startAutoUpdates(); }});
  })();
</script>
</body>
</html>
