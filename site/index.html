<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MedorCoin — Index</title>
  <meta name="theme-color" content="#c7a652" />
  <style>
    :root{
      --gold:#c7a652; --gold-2:#e4c272; --bg:#faf6ea; --ink:#1e2126;
      --panel:#fffdf8; --border:#e2d3ae; --muted:#545b66; --ok:#1f7a46; --danger:#8a1d1d;
      --pill:#eef2ff; --pill-b:#c7cff7; --pill-ink:#2d3c8f;
    }
    *{box-sizing:border-box}
    body{font-family:Inter,Arial,sans-serif;background:var(--bg);color:var(--ink);margin:0}
    a{color:#2d3c8f;text-decoration:none}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px;margin:10px 0}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .grid{display:grid;gap:12px}
    @media(min-width:1000px){.grid-2{grid-template-columns:1fr 1fr}}
    .btn{padding:8px 12px;border-radius:10px;border:1px solid #c3a156;background:linear-gradient(135deg,#fff1c1,var(--gold-2));cursor:pointer}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:var(--pill);border:1px solid var(--pill-b);color:var(--pill-ink);font-size:12px}
    .kv{color:#4a4f57;font-size:13px}
    .addr{font-family:ui-monospace, Menlo, Consolas, monospace; font-size:12px; background:#fff7e0; padding:6px 8px; border-radius:8px; border:1px dashed #d8c089}
    .banner{position:sticky;top:0;z-index:50;background:#fff4d6;border-bottom:2px solid #e7cc82;color:#5b4100;padding:10px 12px;font-weight:600;display:none}
    .banner .tag{background:#ffe6a3;border:1px solid #d3b66e;color:#704f00;padding:2px 8px;border-radius:999px;margin-right:8px}
    .warn{color:var(--danger);font-weight:600}
    .success{color:var(--ok)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #efe5c6;text-align:left}
    th{background:#fff5cc}
    .small{font-size:12px;color:#6b7280}
    .copy-btn{margin-left:8px;padding:2px 6px;border-radius:6px;border:1px solid #c3a156;background:#fff8d8;cursor:pointer;font-size:12px}
    .section-title{display:flex;align-items:center;justify-content:space-between}
    .note{background:#fff9e6;border:1px solid #f0dfab;padding:8px;border-radius:8px}
    .hero{display:flex;flex-wrap:wrap;gap:14px;align-items:center;justify-content:space-between}
  </style>
</head>
<body>
  <div id="demoBanner" class="banner">
    <span class="tag">DEMO</span>
    Running in Mock Mode. Payments are simulated; unlocks and certificates are for testing only.
  </div>

  <div class="wrap">
    <div class="hero">
      <h1>MedorCoin — Index</h1>
      <div class="row">
        <a class="btn" href="/index.html">Home</a>
        <a class="btn" href="/learners.html">Learners</a>
        <a class="btn" href="/my-classroom.html">My Classroom</a>
      </div>
    </div>

    <div class="panel">
      <div class="row">
        <input id="email" placeholder="you@example.com" style="min-width:260px" />
        <button class="btn" onclick="saveEmail()">Use this email</button>
        <span id="userOut" class="kv"></span>
      </div>
    </div>

    <div class="grid grid-2">
      <div class="panel">
        <div class="section-title">
          <h3>Purchase Access</h3>
          <span class="pill">MOCK_MODE aware</span>
        </div>
        <div class="note small">In DEMO, any tx hash with length ≥ 10 verifies.</div>

        <div style="margin-top:10px">
          <label>Track</label><br />
          <select id="track">
            <option value="spot">Spot</option>
            <option value="futures">Futures</option>
            <option value="options">Options</option>
          </select>
        </div>
        <div class="row" style="margin-top:10px">
          <label><input type="radio" name="itemType" value="level" checked /> Single Level</label>
          <label><input type="radio" name="itemType" value="bundle" /> Bundle (L1–L5)</label>
        </div>
        <div id="levelRow" style="margin-top:10px">
          <label>Level</label><br />
          <select id="level">
            <option value="1">Level 1</option>
            <option value="2">Level 2</option>
            <option value="3">Level 3</option>
            <option value="4">Level 4</option>
            <option value="5">Level 5</option>
          </select>
        </div>

        <div class="panel" style="margin-top:12px">
          <div class="section-title">
            <h4>Send Payment To</h4>
            <span class="small">Use the address for your network</span>
          </div>

          <div class="row">
            <div>
              <div><b>ETH</b> <span class="addr" id="addr-eth"></span><button class="copy-btn" onclick="copyAddr('eth')">Copy</button></div>
              <div class="small">Network: Ethereum</div>
            </div>
            <div>
              <div><b>BNB</b> <span class="addr" id="addr-bnb"></span><button class="copy-btn" onclick="copyAddr('bnb')">Copy</button></div>
              <div class="small">Network: BNB Smart Chain</div>
            </div>
            <div>
              <div><b>BTC</b> <span class="addr" id="addr-btc"></span><button class="copy-btn" onclick="copyAddr('btc')">Copy</button></div>
              <div class="small">Network: Bitcoin</div>
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <input id="txHash" placeholder="Paste your transaction hash" style="min-width:320px" />
            <select id="network">
              <option value="eth">ETH</option>
              <option value="bnb">BNB</option>
              <option value="btc">BTC</option>
            </select>
            <button class="btn" onclick="verifyPayment()">Verify & Unlock</button>
          </div>
          <div id="payOut" class="kv" style="margin-top:6px"></div>
        </div>
      </div>

      <div class="panel">
        <h3>Your Access</h3>
        <div class="kv">Unlocked levels for your email.</div>
        <div class="grid" style="grid-template-columns:1fr 1fr 1fr; gap:8px; margin-top:8px">
          <div>
            <h4>Spot</h4>
            <div id="spotLevels"></div>
          </div>
          <div>
            <h4>Futures</h4>
            <div id="futuresLevels"></div>
          </div>
          <div>
            <h4>Options</h4>
            <div id="optionsLevels"></div>
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <button class="btn" onclick="refreshAccess()">Refresh</button>
          <a class="btn" href="/my-classroom.html">Open My Classroom</a>
        </div>
      </div>
    </div>

    <div class="panel">
      <h3>Certificates</h3>
      <div class="kv">Issue a test certificate, then verify it.</div>
      <div class="row" style="margin-top:8px">
        <input id="fullName" placeholder="Your Full Name" />
        <select id="certTrack">
          <option value="spot">Spot</option>
          <option value="futures">Futures</option>
          <option value="options">Options</option>
        </select>
        <button class="btn" onclick="issueCert()">Issue Certificate</button>
      </div>
      <div id="certOut" class="kv" style="margin-top:6px"></div>

      <div class="row" style="margin-top:10px">
        <input id="verifyId" placeholder="Enter Certificate ID (e.g., MC-XX-ABC123-123456)" style="min-width:320px" />
        <button class="btn" onclick="verifyCert()">Verify</button>
      </div>
      <div id="verifyOut" class="kv" style="margin-top:6px"></div>
    </div>

    <div class="panel">
      <h3>Payments History</h3>
      <div class="kv">Recent purchases for your email.</div>
      <table style="margin-top:8px">
        <thead><tr><th>When</th><th>Item</th><th>Network</th><th>Tx</th><th>Amount (USD)</th></tr></thead>
        <tbody id="payTable"><tr><td colspan="5" class="small">No data</td></tr></tbody>
      </table>
      <div class="row" style="margin-top:10px">
        <button class="btn" onclick="loadPayments()">Reload</button>
      </div>
    </div>
  </div>

  <script>
    // Inline config (MOCK_MODE switch)
    window.__ENV = window.__ENV || {
      MOCK_MODE: true,
      API_BASE: ''
    };
    const ENV = window.__ENV;
    const API = ENV.API_BASE || '';
    const MOCK = String(ENV.MOCK_MODE).toLowerCase() === 'true';

    // Payment addresses
    const ADDR = {
      eth: '0x85708d61FEfcbb6eb13C72b0D42bCeB246F06dd0',
      bnb: '0x85708d61FEfcbb6eb13C72b0D42bCeB246F06dd0',
      btc: 'bc1qlw9h0nnde9yewacdkfetcym96l24ucu5ld9atv'
    };

    const state = { email:null };

    function init(){
      // Fill addresses
      document.getElementById('addr-eth').textContent = ADDR.eth;
      document.getElementById('addr-bnb').textContent = ADDR.bnb;
      document.getElementById('addr-btc').textContent = ADDR.btc;

      // Restore email
      const e = localStorage.getItem('learnerEmail');
      if(e){ state.email = e; document.getElementById('email').value = e; }
      updateUserOut();

      // UI toggles
      toggleDemoBanner();
      handleItemTypeChange();
      document.querySelectorAll('input[name="itemType"]').forEach(r=>{
        r.addEventListener('change', handleItemTypeChange);
      });

      // Data
      refreshAccess();
      loadPayments();
    }

    function toggleDemoBanner(){
      document.getElementById('demoBanner').style.display = MOCK ? 'block' : 'none';
    }

    function handleItemTypeChange(){
      const val = document.querySelector('input[name="itemType"]:checked')?.value || 'level';
      document.getElementById('levelRow').style.display = val === 'level' ? 'block' : 'none';
    }

    function saveEmail(){
      const e = document.getElementById('email').value.trim();
      if(!e) return alert('Enter email');
      state.email = e;
      localStorage.setItem('learnerEmail', e);
      updateUserOut();
      refreshAccess();
      loadPayments();
    }

    function updateUserOut(){
      const e = state.email || document.getElementById('email').value.trim();
      state.email = e || null;
      document.getElementById('userOut').textContent = e ? `Using ${e}` : 'No email set.';
    }

    function itemString(){
      const track = document.getElementById('track').value;
      const itemType = document.querySelector('input[name="itemType"]:checked')?.value || 'level';
      if(itemType === 'bundle') return `${track}-bundle`;
      const lvl = document.getElementById('level').value;
      return `${track}-level-${lvl}`;
    }

    async function verifyPayment(){
      if(!state.email) return alert('Set your email first.');
      const txHash = document.getElementById('txHash').value.trim();
      const network = document.getElementById('network').value;
      const item = itemString();
      if(!txHash) return alert('Paste your transaction hash first.');

      const out = document.getElementById('payOut');
      out.textContent = 'Verifying...';

      try{
        let r;
        if(network === 'btc'){
          r = await fetch(`${API}/api/payments/btc/verify`, {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({email: state.email, item, txHash})
          });
        } else {
          r = await fetch(`${API}/api/payments/evm/verify`, {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({email: state.email, item, network, txHash})
          });
        }
        const j = await r.json();
        if(j.paid){
          out.innerHTML = `<span class="success">Payment verified.</span> Unlocked: ${j.bundle? 'Bundle (L1–L5)': `Level ${j.level}`} for ${j.track}. Amount: $${j.amountUsd}`;
          await refreshAccess();
          await loadPayments();
        } else {
          out.innerHTML = `<span class="warn">Not verified.</span> Confirmations: ${j.confirmations||0}`;
        }
      }catch(err){
        out.innerHTML = `<span class="warn">Verification failed.</span>`;
      }
    }

    async function refreshAccess(){
      const email = state.email || document.getElementById('email').value.trim();
      if(!email){
        ['spot','futures','options'].forEach(t=>renderLevels(t,{}));
        return;
      }
      try{
        const r = await fetch(`${API}/api/courses/access?email=${encodeURIComponent(email)}`);
        const acc = await r.json();
        renderLevels('spot', acc.spot||{});
        renderLevels('futures', acc.futures||{});
        renderLevels('options', acc.options||{});
      }catch(e){
        ['spot','futures','options'].forEach(t=>renderLevels(t,{}));
      }
    }

    function renderLevels(track, obj){
      const el = document.getElementById(track+'Levels');
      let html = '';
      for(let i=1;i<=5;i++){
        const u = !!obj['l'+i];
        html += `<div class="row" style="justify-content:space-between;margin:4px 0">
          <div>Level ${i} ${u?'<span class="pill" style="background:#e9f7ef;border-color:#bcd5c1;color:#1f7a46">Unlocked</span>':'<span class="pill">Locked</span>'}</div>
          <div>${u?`<a class="btn" href="/my-classroom.html">Open</a>`:`<span class="small">Complete prior level or purchase</span>`}</div>
        </div>`;
      }
      el.innerHTML = html;
    }

    async function issueCert(){
      if(!state.email) return alert('Set your email first.');
      const name = document.getElementById('fullName').value.trim();
      const track = document.getElementById('certTrack').value;
      if(!name) return alert('Enter your full name.');
      const out = document.getElementById('certOut');
      out.textContent = 'Issuing...';
      try{
        const r = await fetch(`${API}/api/cert/issue`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({email: state.email, name, track})
        });
        const j = await r.json();
        if(j.certId){
          out.innerHTML = `Issued <b>${j.certId}</b>. <a href="${j.pdfUrl}" target="_blank">Download PDF</a>`;
        }else{
          out.textContent = 'Issue failed.';
        }
      }catch(e){
        out.textContent = 'Issue failed.';
      }
    }

    async function verifyCert(){
      const id = document.getElementById('verifyId').value.trim();
      if(!id) return alert('Enter certificate ID.');
      const out = document.getElementById('verifyOut');
      out.textContent = 'Checking...';
      try{
        const r = await fetch(`${API}/api/cert/verify?id=${encodeURIComponent(id)}`);
        const j = await r.json();
        if(j.valid){
          out.innerHTML = `Valid ✅ — ${j.name} • ${j.track} • ${new Date(j.date).toLocaleString()}`;
        }else{
          out.innerHTML = `Invalid or revoked ❌`;
        }
      }catch(e){
        out.textContent = 'Verification failed.';
      }
    }

    async function loadPayments(){
      const email = state.email || document.getElementById('email').value.trim();
      const tb = document.getElementById('payTable');
      if(!email){ tb.innerHTML = `<tr><td colspan="5" class="small">Set your email to view history.</td></tr>`; return; }
      try{
        const r = await fetch(`${API}/api/payments/history?email=${encodeURIComponent(email)}`);
        const j = await r.json();
        const rows = (j.items||[]).map(it=>`
          <tr>
            <td>${new Date(it.at).toLocaleString()}</td>
            <td>${it.bundle?`${it.track} bundle`:`${it.track} level ${it.level}`}</td>
            <td>${it.network.toUpperCase()}</td>
            <td class="small">${it.txHash}</td>
            <td>$${it.amountUsd}</td>
          </tr>
        `).join('');
        tb.innerHTML = rows || `<tr><td colspan="5" class="small">No payments yet.</td></tr>`;
      }catch(e){
        tb.innerHTML = `<tr><td colspan="5" class="small">Failed to load.</td></tr>`;
      }
    }

    function copyAddr(net){
      const val = ADDR[net];
      navigator.clipboard.writeText(val).then(()=>{
        alert(`${net.toUpperCase()} address copied`);
      });
    }

    // Start
    init();
  </script>
</body>
</html>
